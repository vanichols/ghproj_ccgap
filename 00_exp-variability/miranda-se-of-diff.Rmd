---
title: "Miranda-se-diff"
author: "Gina Nichols"
date: "1/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidysawyer2) #--this is a private repo right now, sorry
library(grafify)

theme_set(theme_bw())

dat_miranda <- ia_yields_se %>%  
  group_by(site) %>% #--each site has it's own maximum nrate
  filter(nrate_kgha == max(nrate_kgha))

ylds <- 
  dat_miranda %>% 
  select(site, year, rotation, nrate_kgha, yield_kgha) %>% 
  pivot_wider(names_from = rotation, values_from = yield_kgha) %>% 
  filter(!is.na(sc)) 
  

sds <- 
  dat_miranda %>% 
  select(site, year, rotation, nrate_kgha, sd_kgha) %>% 
  pivot_wider(names_from = rotation, values_from = sd_kgha) %>% 
  rename("cc_sd" = cc,
         "sc_sd" = sc) %>% 
  filter(!is.na(sc_sd))
sds

dat <- 
  ylds %>% 
  left_join(sds) %>% 
  mutate(
    gap_kgha = sc - cc
  ) %>% 
  filter(!is.na(gap_kgha)) %>% 
  filter(!(site == "lewi" & year == 2013))
dat    

```
 
 From Miranda:
 Each mean is normally distributed ($\sigma^2$ = population variance, assumed equal):
 
 $\overline{X}_i \sim N(\mu_i, var = \sigma^2/\sqrt{4})$ for i = 1, 2

 So $\overline{X}_1 - \overline{X}_2 \sim N(\mu, var = \sigma^2/2 + \sigma^2/2)$

 And we pool/average the two standard deviation estimates to get $\sigma^2$:
 
 $\sigma^2 = 1/2 * (\sigma^2_1 + \sigma^2_2)$
 Each mean is normally distributed ($\sigma^2$ = population variance, assumed equal):
 
 $\bar{X}_i \sim N(\mu_i, var = \sigma^2/\sqrt{4})$ for i = 1, 2

 So $\bar{X}_1 - \bar{X}_2 \sim N(\mu, var = \sigma^2/2 + \sigma^2/2)$

 And we pool/average the two standard deviation estimates to get $\sigma^2$:
 
 $\sigma^2 = 1/2 * (\sigma^2_1 + \sigma^2_2)$

Old code, I don't think Miranda touched it
```{r}
dat2 <-
  dat %>%
  mutate(
    term1 = (cc_sd) ^ 2,
    term2 = (sc_sd) ^ 2,
    gap_sd = sqrt(1/2*(term1 + term2))
  )

dat2 %>%
  ggplot(aes(year, gap_kgha)) +
  geom_linerange(aes(ymin = gap_kgha - 1.96*gap_sd, # 1.96 for 95% CI
                     ymax = gap_kgha + 1.96*gap_sd,
                     color = site)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_grid(nrate_kgha~site)
```


