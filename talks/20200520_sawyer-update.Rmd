---
title: "Sawyer Update"
author: "Gina Nichols"
date: "5/20/2020"
output: ioslides_presentation
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(tidysawyer2)
```

## Motivation

```{r motivation}

dat <- saw_tidysawyer %>% 
  select(crop, site, year, rotation, nrate_kgha, yield_kgha) %>% 
  mutate(datatype = "experimental") %>% 
  bind_rows(saw_tidyapsim %>% 
              select(-rotation) %>% 
              rename(rotation = rotation2) %>% 
              mutate(datatype = "apsim"))


dat_seg <- 
  dat %>% 
  group_by(crop, nrate_kgha, rotation, datatype) %>%
  summarise(n = n(),
            yield_kgha = mean(yield_kgha, na.rm = TRUE)) %>% 
  group_by(crop, rotation, datatype) %>% 
  mutate(mx_nrate_kgha = max(nrate_kgha)) %>%
  ungroup() %>%
  filter(nrate_kgha == mx_nrate_kgha) %>% 
  mutate(rotation = recode(rotation,
                           "cc" = "Continuous Corn",
                           "sc" = "Soybean-Corn")) %>%
  select(rotation, datatype, yield_kgha) %>% 
  pivot_wider(names_from = datatype, values_from = yield_kgha) %>% 
  mutate(nrate_kgha = 265)

dat %>%
  group_by(crop, nrate_kgha, rotation, datatype) %>%
  summarise(n = n(),
            yield_kgha = mean(yield_kgha, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(rotation = recode(rotation,
                           "cc" = "Continuous Corn",
                           "sc" = "Soybean-Corn")) %>%
  filter(n > 20) %>%
  ggplot(aes(nrate_kgha, yield_kgha/1000)) +
  geom_line(aes(color = datatype), size = 3) +
  geom_segment(data = dat_seg, aes(x = nrate_kgha,
                                   xend = nrate_kgha,
                                   yend = experimental/1000,
                                   y = apsim/1000),
               arrow = arrow(length = unit(0.1, "inches")),
               size = 1.5,
               color = "red") +
  scale_color_manual(values = c("apsim" = "darkred",
                                "experimental" = "deepskyblue")) +
  labs(x = "Nitrogen Rate (kg/ha)",
       y = "Yield (Mg/ha)",
       title = "Iowa Data",
       color = "Data Type") +
  theme_bw() +
  theme(legend.position = c(1,0),
        legend.justification = c(1,0),
        legend.background = element_rect(color = "black"),
        strip.text = element_text(size = rel(1.4)),
        axis.title = element_text(size = rel(1.2))) +
  facet_grid(. ~ rotation)


```


## Iowa and Illinois Yields Over Time

```{r yields, out.width='100%'}
knitr::include_graphics("../00_exp-explore/fig_yields-over-time.png")

```

## Yield Gaps

```{r gaps, out.width='100%'}

```


## What variables did we look at in Iowa?

```{r vars, out.width='60%'}
knitr::include_graphics("../01_create-features/tbl_preds-all.png")

```

## What environments are associated with higher yield gaps?

```{r lasso, out.width='100%'}
knitr::include_graphics("../02_fit-models/fig_lasso-pctgap.png")

```

## Does the penalty increase over time? Lit review


```{r, out.width='100%'}
knitr::include_graphics("../figs/lit_years-in-corn.png")
```


## Possible targets in APSIM?


```{r apsim, out.width='100%', out.height='100%'}
knitr::include_graphics("../03_sims/fig_all-factor-gaps-windmill.png")

```

## Summary and next steps
*Summary:*

- Cold wet springs and hot early growing seasons enhance rotation effect at high N rates
- Penalty is only sensitive to previous year's crop (number of years in corn not important)

*Next:*

- Include IL data in random forest variable selection and LASSO regression
- Implement select changes in APSIM, assess how model performs at other sites w/those changes